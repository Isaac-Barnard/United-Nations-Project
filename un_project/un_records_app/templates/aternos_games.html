{% extends 'records_base.html' %}

{% block title %}Aternos Games{% endblock %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/records_styles.css' %}">
<link rel="stylesheet" href="{% static 'css/aternos_games_styles.css' %}">
{% endblock %}

{% block content %}
<div class="page-container">

    <h1>Aternos Games</h1>
    <hr>

    {% for game in games %}
        <div class="game-block">
            <h2>{{ game.name }}</h2>

            <p><strong>Participating Nations:</strong>
                {% for nat in game.participating_nations.all %}
                    {{ nat.name }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                    <em>No nations listed</em>
                {% endfor %}
            </p>

            <h3>Events</h3>
            {% for event in game.events.all %}
                <div class="event-block">
                    <h4 class="event-header"><strong>{{ event.name }} Scoring</strong></h4>
                    {% if event.stages.all %}
                        {% if event.event_type == "TOURNAMENT" %}
                            {# Tournament bracket display #}
                            <div class="tournament-bracket">
                                {% for stage in event.stages.all %}
                                    <div class="bracket-round">
                                        <div class="round-label">{{ stage.display_name }}</div>

                                        <div class="matchups">
                                            {% for matchup in stage.matchups %}
                                            <div class="matchup">
                                                {% if matchup %}
                                                    {% for r in matchup %}
                                                        <div class="participant">
                                                            {{ r.participant.player_name }} ({{ r.participant.nation.abbreviation }})
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    {# empty placeholder keeps bracket aligned #}
                                                    <div class="participant empty"></div>
                                                    <div class="participant empty"></div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            {# Points and Time events - original table format #}
                            <table class="event-table">
                                <thead>
                                    <tr>
                                        <th class="stage-header">Stage</th>
                                        {% for part in event.participants.all %}
                                            <th>{{ part.player_name }} ({{ part.nation.abbreviation }})</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stage in event.stages.all %}
                                        <tr>
                                            <td class="stage-name">{{ stage.name }}</td>
                                            
                                            {% for part in event.participants.all %}
                                                <td>
                                                    {% if event.event_type == "POINTS" %}
                                                        {% for r in stage.point_results.all %}
                                                            {% if r.participant.id == part.id %}
                                                                {% if r.disqualified %}
                                                                    <s>{{ r.points }} pts</s>
                                                                    <span class="disqualified">DQ</span>
                                                                {% else %}
                                                                    {{ r.points }} pts
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    
                                                    {% elif event.event_type == "TIME" %}
                                                        {% for r in stage.time_results.all %}
                                                            {% if r.participant.id == part.id %}
                                                                {% if r.disqualified %}
                                                                    <s>{{ r.time_seconds }}s</s>
                                                                    <span class="disqualified">DQ</span>
                                                                {% else %}
                                                                    {{ r.time_seconds }}s
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    {% else %}
                        <p><em>No stages listed.</em></p>
                    {% endif %}
                </div>
            {% empty %}
                <p><em>No events listed.</em></p>
            {% endfor %}
        </div>

        <hr>
    {% empty %}
        <p>No Aternos Games found.</p>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}

{% endblock %}