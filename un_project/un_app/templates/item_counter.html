{% extends 'base.html' %}

{% block title %}Item Counter{% endblock %}

{% load static %}
{% load custom_filters %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/item_counter_styles.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <h1>Item Counter</h1>

    <div class="selector-container">
        <!-- Nation Selector -->
        <div class="entity-selector">
            <form method="get" class="nation-selector">
                <select name="nation" class="form-control" onchange="handleNationChange(this)">
                    <option value="">Select a Nation</option>
                    {% for nation in nations %}
                        <option value="{{ nation.id }}" {% if selected_nation.id == nation.id %}selected{% endif %}>
                            {{ nation.name }} ({{ nation.abbreviation }})
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    
        <!-- Company Selector -->
        <div class="entity-selector">
            <form method="get" class="company-selector">
                <select name="company" class="form-control" onchange="handleCompanyChange(this)">
                    <option value="">Select a Company</option>
                    {% for company in companies %}
                        <option value="{{ company.id }}" {% if selected_company.id == company.id %}selected{% endif %}>
                            {{ company.name }} ({{ company.abbreviation }})
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>

    {% if selected_nation or selected_company %}
        <div class="counter-form">
            <h2>Add/Update Counts for {% if selected_nation %}{{ selected_nation.name }}{% else %}{{ selected_company.name }}{% endif %}</h2>
            <form method="post" id="counterForm">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="btn btn-primary">Update Count</button>
            </form>
        </div>

        <!-- Liquid Assets Section -->
        <h2 class="liquid-heading">Liquid Assets</h2>
        <table class="liquid-table">
            <thead>
                <tr style="font-size: .95em;">
                    <th>Asset Name</th>
                    <th>Total in Diamonds</th>
                    {% for denomination in denominations %}
                        <th>{{ denomination.name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody style="font-size: .95em;">
                {% for asset_data in liquid_asset_data %}
                <tr style="font-size: .95em;">
                    <td>{{ asset_data.container_name }}</td>
                    <td class="right-align">{{ asset_data.total_in_diamonds|custom_decimal_places }}</td>
                    {% for count in asset_data.counts %}
                        <td class="right-align">{{ count|stringformat:"g" }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
                <!-- Input Row -->
                <tr class="input-row">
                    <form method="post" id="liquidForm">
                        {% csrf_token %}
                        <td>
                            <select name="container" class="form-control input-cell" required>
                                <option value="">Select Container</option>
                                {% for asset_data in liquid_asset_data %}
                                    <option value="{{ asset_data.container_name }}">{{ asset_data.container_name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="right-align">
                            <span id="total_diamonds">0.000000</span>
                        </td>
                        {% for denomination in denominations %}
                            <td>
                                <input type="number" 
                                       name="denomination_{{ denomination.id }}" 
                                       class="form-control input-cell" 
                                       value="0" 
                                       step="0.001" 
                                       min="0"
                                       style="width: 100%; text-align: right;"
                                       data-diamond-equivalent="{{ denomination.diamond_equivalent }}">
                            </td>
                        {% endfor %}
                    </form>
                </tr>
            </tbody>
        </table>
        <div style="text-align: right; margin-top: 10px;">
            <button type="submit" form="liquidForm" class="btn btn-primary">Update Liquid Assets</button>
        </div>

        <!-- Items Section -->
        <h2 class="items-heading">Items</h2>
        <div class="item-table-container">
            {% for items_part in items_parts %}
                <div class="item-table">
                    <table>
                        <thead>
                            <tr style="font-size: 0.9em;">
                                <th>Item Type</th>
                                <th>Total Value</th>
                                <th>Market Value</th>
                                <th>Number Owned</th>
                                <th>Update</th>
                            </tr>
                        </thead>
                        <tbody style="font-size: 0.9em;">
                            {% for item in items_part %}
                                {% if 'Section Divider' in item.name %}
                                    <tr>
                                        <td colspan="5" style="background-color: transparent;">&nbsp;</td>
                                    </tr>
                                {% else %}
                                    <tr style="font-size: 0.9em;" class="item-row" data-item-name="{{ item.name }}">
                                        <td class="item-name">{{ item.name }}</td>
                                        <td class="right-align total-value">{{ item.total_value|custom_decimal_places }}</td>
                                        <td class="right-align">{{ item.market_value|custom_decimal_places }}</td>
                                        <td class="right-align current-count">{{ item.count|stringformat:"g" }}</td>
                                        <td>
                                            <input type="number" 
                                                class="item-input form-control input-cell"
                                                value="0"
                                                step="0.001"
                                                min="0"
                                                style="width: 100%; text-align: right; padding: 2px 4px; height: 22px; font-size: 0.9em;">
                                        </td>
                                    </tr>
                                {% endif %}
                            {% empty %}
                                <tr>
                                    <td colspan="5">No items found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        </div>
        <div class="total-value-sum">
            <h3>Total Value of All Items: {% if selected_nation %}{{ selected_nation.total_item_asset_value|custom_decimal_places }}{% else %}{{ selected_company.total_item_asset_value|custom_decimal_places }}{% endif %}</h3>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const liquidForm = document.getElementById('liquidForm');
    
    liquidForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get the selected nation or company ID
        const nationSelect = document.querySelector('select[name="nation"]');
        const companySelect = document.querySelector('select[name="company"]');
        const nationId = nationSelect.value;
        const companyId = companySelect.value;
        
        // Add the nation/company ID to the form data
        const formData = new FormData(liquidForm);
        if (nationId) formData.append('nation_id', nationId);
        if (companyId) formData.append('company_id', companyId);
        
        // Submit the form via AJAX
        fetch('/handle-liquid-asset-update/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Reload the page to show updated data
                window.location.reload();
            } else {
                alert('Error updating liquid assets: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating liquid assets');
        });
    });
});


    function updateTotalDiamonds() {
        let total = 0;
        const inputs = document.querySelectorAll('.input-cell[type="number"]');
        inputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            const diamondEquivalent = parseFloat(input.dataset.diamondEquivalent);
            total += value * diamondEquivalent;
        });
        document.getElementById('total_diamonds').textContent = total.toFixed(6);
    }

document.addEventListener('DOMContentLoaded', function() {
    const nationSelect = document.querySelector('select[name="nation"]');
    const companySelect = document.querySelector('select[name="company"]');
    const containerSelect = document.querySelector('select[name="container"]');
    const itemSelect = document.querySelector('select[name="item"]');
    const denominationSelect = document.querySelector('select[name="denomination"]');

    // Update containers when entity changes
    async function updateContainers(entityType, entityId) {
        if (entityId) {
            const queryParam = entityType === 'nation' ? `nation_id=${entityId}` : `company_id=${entityId}`;
            const response = await fetch(`/get-containers/?${queryParam}`);
            const data = await response.json();
            
            containerSelect.innerHTML = '<option value="">Select a Container</option>';
            data.containers.forEach(container => {
                containerSelect.innerHTML += `
                    <option value="${container.id}">${container.name}</option>
                `;
            });
        }
    }

    function handleNationChange(select) {
        if (select.value) {
            companySelect.value = '';
            companySelect.disabled = true;
            updateContainers('nation', select.value);
            select.form.submit();
        } else {
            companySelect.disabled = false;
        }
    }

    function handleCompanyChange(select) {
        if (select.value) {
            nationSelect.value = '';
            nationSelect.disabled = true;
            updateContainers('company', select.value);
            select.form.submit();
        } else {
            nationSelect.disabled = false;
        }
    }

    // Initialize disabled states
    if (nationSelect.value) {
        companySelect.disabled = true;
    } else if (companySelect.value) {
        nationSelect.disabled = true;
    }

    // Add the handlers to the window object so they can be called from inline handlers
    window.handleNationChange = handleNationChange;
    window.handleCompanyChange = handleCompanyChange;

    // Rest of your existing JavaScript remains the same
    itemSelect.addEventListener('change', function() {
        if (this.value) {
            containerSelect.value = '';
            denominationSelect.value = '';
            containerSelect.disabled = true;
            denominationSelect.disabled = true;
        } else {
            containerSelect.disabled = false;
            denominationSelect.disabled = false;
        }
    });

    containerSelect.addEventListener('change', function() {
        if (this.value) {
            itemSelect.value = '';
            itemSelect.disabled = true;
        } else {
            itemSelect.disabled = false;
        }
    });
    updateTotalDiamonds();
});

document.addEventListener('DOMContentLoaded', function() {
    const itemInputs = document.querySelectorAll('.item-input');
    
    itemInputs.forEach(input => {
        input.addEventListener('change', function() {
            const row = this.closest('.item-row');
            const itemName = row.dataset.itemName;
            const count = this.value;
            
            // Get the selected nation or company ID
            const nationSelect = document.querySelector('select[name="nation"]');
            const companySelect = document.querySelector('select[name="company"]');
            const nationId = nationSelect.value;
            const companyId = companySelect.value;
            
            // Create form data
            const formData = new FormData();
            formData.append('item_name', itemName);
            formData.append('count', count);
            if (nationId) formData.append('nation_id', nationId);
            if (companyId) formData.append('company_id', companyId);
            
            // Submit the update
            fetch('/handle-item-update/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update with pre-formatted strings from the server
                    row.querySelector('.total-value').textContent = data.new_total_value;
                    row.querySelector('.current-count').textContent = data.new_count;
                    // Reset input to 0
                    this.value = '0';
                } else if (data.status === 'ignored') {
                    // Just reset the input to 0
                    this.value = '0';
                } else {
                    alert('Error updating item: ' + data.message);
                    this.value = '0';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating item');
                this.value = '0';
            });
        });
    });
});
</script>
{% endblock %}